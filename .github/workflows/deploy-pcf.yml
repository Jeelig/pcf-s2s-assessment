name: Trouver un run avec artéfact contenant une chaîne

on:
  workflow_dispatch:
    inputs:
      workflow_file:
        description: 'Nom du fichier workflow (ex: build.yml)'
        required: true
        default: 'build.yml'
      search_string:
        description: 'Chaîne à rechercher dans le nom des artéfacts'
        required: true
        default: 'recherche'

jobs:
  find-artifact:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read  # Nécessaire pour lister les runs et artéfacts
    outputs:
      run_id: ${{ steps.find.outputs.run_id }}
      artifact_id: ${{ steps.find.outputs.artifact_id }}
      artifact_name: ${{ steps.find.outputs.artifact_name }}
    steps:
      - name: Vérifier les entrées
        run: |
          echo "Workflow fichier : ${{ inputs.workflow_file }}"
          echo "Recherche dans artéfacts : '${{ inputs.search_string }}'"

      - name: Récupérer l'ID du workflow
        id: get-workflow-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_FILE="${{ inputs.workflow_file }}"
          echo "Récupération de l'ID du workflow : $WORKFLOW_FILE"

          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows" \
            --jq ".workflows[] | select(.path == \".github/workflows/$WORKFLOW_FILE\") | .id" > workflow_id.txt

          WORKFLOW_ID=$(cat workflow_id.txt)

          if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
            echo "❌ Workflow non trouvé : $WORKFLOW_FILE"
            exit 1
          fi

          echo "✅ Workflow ID = $WORKFLOW_ID"
          echo "workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT

      - name: Lister les runs du workflow
        id: list-runs
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          WORKFLOW_ID="${{ steps.get-workflow-id.outputs.workflow_id }}"
          echo "Liste des 50 derniers runs du workflow ID $WORKFLOW_ID..."

          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?per_page=50" \
            --jq '.workflow_runs[] | {id, status, conclusion, artifacts_url}' > runs.json

      - name: Lister les runs du workflow
        run: |
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/build.yml/runs?per_page=50&status=completed" \
            > runs.json
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Chercher un artéfact contenant la chaîne
        id: find
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          SEARCH_STRING: ${{ inputs.search_string }}
        shell: python
        run: |
          import json, os, re, sys, urllib.request

          search = os.environ['SEARCH_STRING'].lower()
          output = os.environ['GITHUB_OUTPUT']

          raw = open("runs.json","r").read()
          print("DEBUG RAW JSON (premières 300 chars) -->")
          print(raw[:300])

          # Extraire le premier payload JSON valide (souvent gh ajoute du spam ligne 1)
          match = re.search(r'(\{.*\})', raw, re.DOTALL)
          if not match:
              print("Pas de JSON détecté.")
              sys.exit(1)

          data = json.loads(match.group(1))

          runs = data.get("workflow_runs", [])
          print(f"Total runs analysés: {len(runs)}")

          found = False

          for run in runs:
              run_id = run['id']
              url = run['artifacts_url']

              req = urllib.request.Request(url, headers={
                  "Authorization": f"token {os.environ['GH_TOKEN']}",
                  "Accept": "application/vnd.github+json"
              })

              try:
                data_art = json.loads(urllib.request.urlopen(req).read().decode())
              except Exception as e:
                print(f"Erreur API run {run_id} : {e}")
                continue

              for a in data_art.get("artifacts",[]):
                  if search in a['name'].lower():
                      with open(output,"a") as gh:
                          gh.write(f"run_id={run_id}\n")
                          gh.write(f"artifact_id={a['id']}\n")
                          gh.write(f"artifact_name={a['name']}\n")
                      print("ARTÉFACT TROUVÉ ✅")
                      print(a)
                      found = True
                      break
              if found: break

          if not found:
              print(f"Aucun artéfact ne contient '{search}'")
              sys.exit(1)

      - name: Résultat final
        run: |
          echo "Run ID avec artéfact : ${{ steps.find.outputs.run_id }}"
          echo "Artifact ID          : ${{ steps.find.outputs.artifact_id }}"
          echo "Nom de l'artéfact    : ${{ steps.find.outputs.artifact_name }}"