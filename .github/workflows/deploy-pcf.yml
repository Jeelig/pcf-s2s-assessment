name: Trouver un run avec artéfact contenant une chaîne

on:
  workflow_dispatch:
    inputs:
      workflow_file:
        description: 'Nom du fichier workflow (ex: build.yml)'
        required: true
        default: 'build.yml'
      search_string:
        description: 'Chaîne à rechercher dans le nom des artéfacts'
        required: true
        default: 'recherche'

jobs:
  find-artifact:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read  # Nécessaire pour lister les runs et artéfacts
    outputs:
      run_id: ${{ steps.find.outputs.run_id }}
      artifact_id: ${{ steps.find.outputs.artifact_id }}
      artifact_name: ${{ steps.find.outputs.artifact_name }}
    steps:
      - name: Vérifier les entrées
        run: |
          echo "Workflow fichier : ${{ inputs.workflow_file }}"
          echo "Recherche dans artéfacts : '${{ inputs.search_string }}'"

      - name: Récupérer l'ID du workflow
        id: get-workflow-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_FILE="${{ inputs.workflow_file }}"
          echo "Récupération de l'ID du workflow : $WORKFLOW_FILE"

          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows" \
            --jq ".workflows[] | select(.path == \".github/workflows/$WORKFLOW_FILE\") | .id" > workflow_id.txt

          WORKFLOW_ID=$(cat workflow_id.txt)

          if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
            echo "❌ Workflow non trouvé : $WORKFLOW_FILE"
            exit 1
          fi

          echo "✅ Workflow ID = $WORKFLOW_ID"
          echo "workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT

      - name: Lister les runs du workflow
        id: list-runs
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          WORKFLOW_ID="${{ steps.get-workflow-id.outputs.workflow_id }}"
          echo "Liste des 50 derniers runs du workflow ID $WORKFLOW_ID..."

          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?per_page=50" \
            --jq '.workflow_runs[] | {id, status, conclusion, artifacts_url}' > runs.json

      - name: Chercher un artéfact contenant la chaîne
        id: find
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          SEARCH_STRING: ${{ inputs.search_string }}
        shell: python
        run: |
          import json
          import os
          import sys
          import urllib.request

          search = os.environ['SEARCH_STRING'].lower()
          found = False
          output = os.environ['GITHUB_OUTPUT']

          # load runs.json
          with open('runs.json', 'r') as f:
              data = json.load(f)

          runs = data.get("workflow_runs", [])
          print(f"Total runs analysés: {len(runs)}")

          for run in runs:
              run_id = run['id']
              artifacts_url = run['artifacts_url']

              print(f"Vérification du run {run_id}...")

              req = urllib.request.Request(artifacts_url)
              req.add_header('Authorization', f"token {os.environ['GH_TOKEN']}")
              req.add_header('Accept', 'application/vnd.github+json')

              try:
                  with urllib.request.urlopen(req) as response:
                      artifacts_data = json.loads(response.read().decode())
                      artifacts = artifacts_data.get('artifacts', [])
              except Exception as e:
                  print(f"Erreur API pour run {run_id}: {e}")
                  continue

              for artifact in artifacts:
                  name = artifact['name'].lower()

                  if search in name:
                      print("✅ ARTÉFACT TROUVÉ")
                      print(f"Run       : {run_id}")
                      print(f"Artifact  : {artifact['id']} - {artifact['name']}")

                      with open(output, "a") as gh_out:
                          gh_out.write(f"run_id={run_id}\n")
                          gh_out.write(f"artifact_id={artifact['id']}\n")
                          gh_out.write(f"artifact_name={artifact['name']}\n")

                      found = True
                      break

              if found:
                  break

          if not found:
              print(f"❌ Aucun artéfact contenant '{search}' trouvé dans les derniers runs.")
              sys.exit(1)

      - name: Résultat final
        run: |
          echo "Run ID avec artéfact : ${{ steps.find.outputs.run_id }}"
          echo "Artifact ID          : ${{ steps.find.outputs.artifact_id }}"
          echo "Nom de l'artéfact    : ${{ steps.find.outputs.artifact_name }}"